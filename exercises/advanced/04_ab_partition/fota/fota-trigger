#!/bin/bash
#
# FOTA Trigger - Command-line tool for FOTA operations
#
# Usage:
#   fota-trigger --status     Show current A/B and FOTA status
#   fota-trigger --check      Check for updates (dry run)
#   fota-trigger --update     Check and apply update if available
#   fota-trigger --rollback   Rollback to previous slot
#   fota-trigger --help       Show this help

set -e

FOTA_CLIENT="/opt/fota/fota_client"
CONFIG_FILE="/etc/fota/fota.conf"
STATE_FILE="/data/fota/state.json"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

usage() {
    cat << EOF
FOTA Trigger - A/B Partition Update Tool

Usage: $(basename "$0") [option]

Options:
  -s, --status     Show current A/B partition and FOTA status
  -c, --check      Check for updates without applying
  -u, --update     Check and apply update if available
  -r, --rollback   Rollback to previous slot
  -l, --logs       Show recent FOTA logs
  -h, --help       Show this help message

Examples:
  $(basename "$0") --status      # Check current state
  $(basename "$0") --update      # Download and apply update
  $(basename "$0") --rollback    # Switch to other slot

EOF
}

check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo -e "${RED}Error: This command requires root privileges${NC}"
        exit 1
    fi
}

get_status() {
    echo "========================================"
    echo "         A/B Partition Status"
    echo "========================================"
    echo ""
    
    # U-Boot environment
    if command -v fw_printenv &> /dev/null; then
        SLOT=$(fw_printenv -n slot 2>/dev/null || echo "unknown")
        BOOTCOUNT=$(fw_printenv -n bootcount 2>/dev/null || echo "unknown")
        BOOTLIMIT=$(fw_printenv -n bootlimit 2>/dev/null || echo "unknown")
        FALCON_SLOT=$(fw_printenv -n falcon_slot 2>/dev/null || echo "disabled")
        FALCON_ENABLED=$(fw_printenv -n falcon_enabled 2>/dev/null || echo "0")
        
        echo -e "Active Slot:      ${GREEN}${SLOT}${NC}"
        echo -e "Boot Count:       ${BOOTCOUNT} / ${BOOTLIMIT}"
        
        if [ "$FALCON_ENABLED" = "1" ]; then
            echo -e "Falcon Mode:      ${GREEN}enabled${NC} (slot: ${FALCON_SLOT})"
        else
            echo -e "Falcon Mode:      ${YELLOW}disabled${NC}"
        fi
    else
        echo -e "${YELLOW}Warning: fw_printenv not found${NC}"
    fi
    
    echo ""
    
    # FOTA configuration
    if [ -f "$CONFIG_FILE" ]; then
        echo "--- FOTA Configuration ---"
        VERSION=$(grep "^current_version=" "$CONFIG_FILE" | cut -d= -f2)
        SERVER=$(grep "^server_url=" "$CONFIG_FILE" | cut -d= -f2)
        DEVICE=$(grep "^device_id=" "$CONFIG_FILE" | cut -d= -f2)
        
        echo "Firmware Version: $VERSION"
        echo "Device ID:        $DEVICE"
        echo "Update Server:    $SERVER"
    else
        echo -e "${YELLOW}Warning: FOTA config not found at $CONFIG_FILE${NC}"
    fi
    
    echo ""
    
    # Pending update
    if [ -f "$STATE_FILE" ]; then
        echo -e "--- ${YELLOW}Pending Update${NC} ---"
        cat "$STATE_FILE"
        echo ""
    fi
    
    # Partition usage
    echo "--- Partition Usage ---"
    echo "Slot A Boot: $(df -h /dev/mmcblk0p1 2>/dev/null | tail -1 | awk '{print $3 "/" $2}' || echo "N/A")"
    echo "Slot A Root: $(df -h /dev/mmcblk0p2 2>/dev/null | tail -1 | awk '{print $3 "/" $2}' || echo "N/A")"
    echo "Slot B Boot: $(df -h /dev/mmcblk0p3 2>/dev/null | tail -1 | awk '{print $3 "/" $2}' || echo "N/A")"
    echo "Slot B Root: $(df -h /dev/mmcblk0p5 2>/dev/null | tail -1 | awk '{print $3 "/" $2}' || echo "N/A")"
    echo ""
}

check_update() {
    echo "Checking for updates..."
    
    if [ -x "$FOTA_CLIENT" ]; then
        "$FOTA_CLIENT" --check --foreground
    else
        echo -e "${RED}Error: FOTA client not found at $FOTA_CLIENT${NC}"
        exit 1
    fi
}

trigger_update() {
    check_root
    
    echo "Triggering update check..."
    
    if [ -x "$FOTA_CLIENT" ]; then
        "$FOTA_CLIENT" --check
    else
        # Fallback: create trigger file for daemon
        touch /tmp/fota_trigger
        echo "Update trigger created. Daemon will process shortly."
    fi
}

rollback() {
    check_root
    
    CURRENT=$(fw_printenv -n slot 2>/dev/null || echo "a")
    
    if [ "$CURRENT" = "a" ]; then
        NEW="b"
    else
        NEW="a"
    fi
    
    echo "========================================"
    echo "            Rollback"
    echo "========================================"
    echo ""
    echo -e "Current slot: ${GREEN}${CURRENT}${NC}"
    echo -e "Target slot:  ${YELLOW}${NEW}${NC}"
    echo ""
    
    read -p "Are you sure you want to rollback? [y/N] " -n 1 -r
    echo ""
    
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Rollback cancelled."
        exit 0
    fi
    
    echo "Setting up rollback..."
    
    # Switch slot
    fw_setenv slot "$NEW"
    fw_setenv bootcount 0
    
    # Update Falcon slot if enabled
    if fw_printenv falcon_enabled 2>/dev/null | grep -q "1"; then
        fw_setenv falcon_slot "$NEW"
    fi
    
    echo -e "${GREEN}Rollback configured to slot $NEW${NC}"
    echo ""
    
    read -p "Reboot now? [y/N] " -n 1 -r
    echo ""
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "Rebooting..."
        reboot
    else
        echo "Reboot when ready to apply rollback."
    fi
}

show_logs() {
    echo "=== Recent FOTA Logs ==="
    if command -v journalctl &> /dev/null; then
        journalctl -u fota -n 50 --no-pager
    else
        grep -i fota /var/log/syslog 2>/dev/null | tail -50 || \
        grep -i fota /var/log/messages 2>/dev/null | tail -50 || \
        echo "No logs found"
    fi
}

# Main
case "${1:-}" in
    -s|--status)
        get_status
        ;;
    -c|--check)
        check_update
        ;;
    -u|--update)
        trigger_update
        ;;
    -r|--rollback)
        rollback
        ;;
    -l|--logs)
        show_logs
        ;;
    -h|--help|"")
        usage
        ;;
    *)
        echo -e "${RED}Unknown option: $1${NC}"
        usage
        exit 1
        ;;
esac
