# U-Boot Network Boot Environment
#
# Import this into U-Boot for network boot configuration
#
# Usage in U-Boot:
#   load mmc 0:1 ${loadaddr} uboot_netboot.env
#   env import -t ${loadaddr} ${filesize}
#   saveenv
#
# Author: Embedded Linux Labs

# ==========================================================================
# NETWORK CONFIGURATION
# ==========================================================================

# Server addresses
serverip=192.168.10.1
gatewayip=192.168.10.1
netmask=255.255.255.0

# Board IP (set to specific or leave for DHCP)
# ipaddr=192.168.10.50

# ==========================================================================
# FILE PATHS
# ==========================================================================

# Files to download
kernel_file=zImage
dtb_file=am335x-boneblack.dtb
initramfs_file=initramfs.cpio.gz

# NFS root path
nfsroot=/export/bbb-root

# ==========================================================================
# MEMORY ADDRESSES
# ==========================================================================

# Load addresses (AM335x specific)
loadaddr=0x82000000
fdtaddr=0x88000000
rdaddr=0x88080000

# ==========================================================================
# BOOT ARGUMENTS
# ==========================================================================

# Console configuration
console=ttyO0,115200n8

# NFS options
nfsopts=v3,tcp,nolock

# ==========================================================================
# BOOT COMMANDS
# ==========================================================================

# Get IP via DHCP and set serverip
netsetup=echo Getting IP via DHCP...; dhcp; echo Server IP: ${serverip}

# Download kernel
tftp_kernel=echo Loading kernel...; tftp ${loadaddr} ${kernel_file}

# Download device tree
tftp_dtb=echo Loading device tree...; tftp ${fdtaddr} ${dtb_file}

# Download initramfs (optional)
tftp_initrd=echo Loading initramfs...; tftp ${rdaddr} ${initramfs_file}

# Set bootargs for NFS root
args_nfs=setenv bootargs console=${console} root=/dev/nfs rw nfsroot=${serverip}:${nfsroot},${nfsopts} ip=dhcp

# Set bootargs for NFS with initramfs
args_nfs_initrd=setenv bootargs console=${console} root=/dev/nfs rw nfsroot=${serverip}:${nfsroot},${nfsopts} ip=dhcp

# Boot kernel with NFS root
boot_nfs=bootz ${loadaddr} - ${fdtaddr}

# Boot kernel with initramfs
boot_nfs_initrd=bootz ${loadaddr} ${rdaddr}:${filesize} ${fdtaddr}

# ==========================================================================
# COMBINED BOOT COMMANDS
# ==========================================================================

# Main network boot command
netboot=echo === Network Boot ===; run netsetup; run tftp_kernel; run tftp_dtb; run args_nfs; run boot_nfs

# Network boot with initramfs
netboot_initrd=echo === Network Boot with Initramfs ===; run netsetup; run tftp_kernel; run tftp_dtb; run tftp_initrd; run args_nfs_initrd; run boot_nfs_initrd

# Debug boot (verbose)
netboot_debug=echo === Network Boot Debug ===; setenv bootargs console=${console} root=/dev/nfs rw nfsroot=${serverip}:${nfsroot},${nfsopts} ip=dhcp debug loglevel=7; run netsetup; run tftp_kernel; run tftp_dtb; run boot_nfs

# ==========================================================================
# FALLBACK COMMANDS
# ==========================================================================

# MMC boot fallback
mmcboot=echo === MMC Boot ===; setenv bootargs console=${console} root=/dev/mmcblk0p2 rw rootwait; load mmc 0:1 ${loadaddr} zImage; load mmc 0:1 ${fdtaddr} ${dtb_file}; bootz ${loadaddr} - ${fdtaddr}

# Try network, fall back to MMC
tryboot=run netboot || run mmcboot

# ==========================================================================
# SET DEFAULT BOOT
# ==========================================================================

# Uncomment to make network boot the default
# bootcmd=run netboot
