# =============================================================================
# GRABSERIAL CONFIGURATION FOR BBB BOOT MEASUREMENT
# =============================================================================
#
# grabserial is a serial port capture tool with precise timestamping.
# These configurations provide optimal settings for boot time measurement.
#
# Install: pip3 install grabserial
#
# Author: Embedded Linux Labs
# License: MIT

# =============================================================================
# BASIC CONFIGURATION
# =============================================================================

# Serial device (USB serial adapter or direct USB)
device = /dev/ttyACM0
# Alternative: /dev/ttyUSB0 for USB-to-serial adapters

# Baud rate (BBB default)
baudrate = 115200

# Show timestamps for each line
time = True

# =============================================================================
# BOOT MEASUREMENT (Full Boot)
# =============================================================================
# Measures from first output to login prompt
#
# Command:
#   grabserial -d /dev/ttyACM0 -b 115200 -t -m "U-Boot SPL" -q "login:"
#
# Options:
#   -t              Show timestamps
#   -m "pattern"    Match pattern to reset timestamp (start marker)
#   -q "pattern"    Quit after matching pattern (end marker)
#   --endtime=N     Timeout after N seconds

# Start marker (first meaningful output)
match = U-Boot SPL

# End marker (boot complete)
quit = login:

# Timeout (max wait time)
endtime = 120

# =============================================================================
# KERNEL-ONLY MEASUREMENT
# =============================================================================
# Measures kernel boot time only
#
# Command:
#   grabserial -d /dev/ttyACM0 -b 115200 -t -m "Starting kernel" -q "Run /sbin/init"

# Start: Kernel handoff from U-Boot
# match = Starting kernel

# End: Init process starts
# quit = Run /sbin/init

# =============================================================================
# U-BOOT-ONLY MEASUREMENT
# =============================================================================
# Measures U-Boot stage only
#
# Command:
#   grabserial -d /dev/ttyACM0 -b 115200 -t -m "U-Boot SPL" -q "Starting kernel"

# Start: SPL starts
# match = U-Boot SPL

# End: Kernel starts
# quit = Starting kernel

# =============================================================================
# INITCALL DEBUG CAPTURE
# =============================================================================
# Captures detailed initcall timing (requires initcall_debug in bootargs)
#
# Command:
#   grabserial -d /dev/ttyACM0 -b 115200 -t -m "Booting Linux" -q "login:" -o initcall.log
#
# Then analyze:
#   grep "initcall.*returned" initcall.log | sort -k2 -t'=' -n

# Output file
# output = initcall.log

# =============================================================================
# COMPARISON MODE
# =============================================================================
# For comparing baseline vs optimized boot
#
# Baseline capture:
#   grabserial -d /dev/ttyACM0 -b 115200 -t -m "U-Boot" -q "login:" -o baseline.log
#
# Optimized capture:
#   grabserial -d /dev/ttyACM0 -b 115200 -t -m "U-Boot" -q "login:" -o optimized.log
#
# Compare:
#   diff baseline.log optimized.log

# =============================================================================
# EXAMPLE FULL COMMANDS
# =============================================================================

# Full boot measurement with file output:
#   grabserial -d /dev/ttyACM0 -b 115200 -t -m "U-Boot SPL" -q "login:" \
#     --endtime=120 -o boot_$(date +%Y%m%d_%H%M%S).log

# Measure with line-by-line elapsed time:
#   grabserial -d /dev/ttyACM0 -b 115200 -t -e -m "U-Boot SPL" -q "login:"

# Quiet mode (just show timing markers):
#   grabserial -d /dev/ttyACM0 -b 115200 -t -m "U-Boot SPL" -q "login:" \
#     -l "Starting kernel,Run /sbin/init,login:"

# =============================================================================
# NOTES
# =============================================================================

# 1. Always power cycle the BBB after starting grabserial
# 2. Use Ctrl-C to abort if boot doesn't start within expected time
# 3. For most accurate timing, use hardware timestamps (-t)
# 4. The -e option shows elapsed time since match, useful for stage timing
# 5. grabserial can miss very early ROM output (before UART init)
