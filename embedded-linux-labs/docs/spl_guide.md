# SPL (Secondary Program Loader) Deep-Dive

> ⚠️ **Auto-Generated Content**: This document was generated by AI. Verify all information against official documentation before use on real hardware.

Understanding the Secondary Program Loader (SPL) and its critical role in the BeagleBone Black boot process.

## What is SPL?

SPL (Secondary Program Loader) is a minimal, stripped-down version of U-Boot that runs immediately after the Boot ROM. It exists because of fundamental hardware constraints during early boot.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    WHY SPL EXISTS                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   THE PROBLEM:                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ Boot ROM can only load small code into limited internal SRAM        │   │
│   │ BeagleBone Black AM335x: 128KB SRAM only!                           │   │
│   │ Full U-Boot is ~500KB-1MB (too big!)                                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   THE SOLUTION: Two-Stage Bootloader                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ Stage 1: SPL (fits in SRAM)                                         │   │
│   │   • Minimal code (~50-100KB)                                        │   │
│   │   • Initializes DDR RAM                                             │   │
│   │   • Loads full U-Boot into DDR                                      │   │
│   │                                                                     │   │
│   │ Stage 2: Full U-Boot (runs from DDR)                                │   │
│   │   • Full feature set                                                │   │
│   │   • Interactive shell                                               │   │
│   │   • Loads kernel, DTB, etc.                                         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## BeagleBone Black Boot Flow with SPL

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                BEAGLEBONE BLACK COMPLETE BOOT SEQUENCE                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   POWER ON                                                                  │
│       │                                                                     │
│       v                                                                     │
│   ┌───────────────────────────────────────────────────────┐                 │
│   │ 1. AM335x Boot ROM (in SoC)                           │                 │
│   │    • Fixed code burned into silicon                   │                 │
│   │    • Checks boot pins (SYSBOOT[4:0])                  │                 │
│   │    • Determines boot source order                     │                 │
│   │    • BBB default: eMMC → SD → UART → USB              │                 │
│   │    • Loads MLO/SPL into 128KB internal SRAM           │                 │
│   │    • Executes SPL                                     │                 │
│   │    Environment: 128KB SRAM, No DDR, No I-cache        │                 │
│   └───────────────────────────────────────────────────────┘                 │
│       │                                                                     │
│       v                                                                     │
│   ┌───────────────────────────────────────────────────────┐                 │
│   │ 2. SPL / MLO (Secondary Program Loader)               │                 │
│   │    • First user-modifiable code                       │                 │
│   │    • Initializes: clocks, PMIC, DDR3 RAM              │                 │
│   │    • Loads u-boot.img into DDR RAM                    │                 │
│   │    • Jumps to U-Boot entry point                      │                 │
│   │    Environment: SRAM → DDR now available              │                 │
│   └───────────────────────────────────────────────────────┘                 │
│       │                                                                     │
│       v                                                                     │
│   ┌───────────────────────────────────────────────────────┐                 │
│   │ 3. U-Boot (Full Bootloader)                           │                 │
│   │    • Runs from DDR RAM (512MB on BBB)                 │                 │
│   │    • Full shell, scripting, network stack             │                 │
│   │    • Loads kernel, DTB, initramfs                     │                 │
│   │    • Configures bootargs                              │                 │
│   │    • Jumps to kernel                                  │                 │
│   └───────────────────────────────────────────────────────┘                 │
│       │                                                                     │
│       v                                                                     │
│   ┌───────────────────────────────────────────────────────┐                 │
│   │ 4. Linux Kernel                                       │                 │
│   │    • Takes over hardware                              │                 │
│   │    • Mounts root filesystem                           │                 │
│   │    • Starts init process                              │                 │
│   └───────────────────────────────────────────────────────┘                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## SPL Naming Conventions

Different platforms use different names for SPL:

| Platform | SPL Filename | Notes |
|----------|-------------|-------|
| **BeagleBone Black** | `MLO` | Master Loader Object (TI convention) |
| i.MX | `SPL` or combined | Often combined with U-Boot |
| STM32MP1 | `u-boot-spl.stm32` | STM32 header format |
| Generic | `u-boot-spl.bin` | Raw binary |
| Signed | `u-boot-spl.bin.signed` | With secure boot signature |

## What SPL Must Do

SPL has very limited resources and must perform only essential tasks:

### 1. Clock Initialization

```c
/* SPL must configure system clocks before anything else works */
// AM335x has multiple PLLs that need configuration:
// - CORE PLL (CPU, DDR)
// - PER PLL (Peripherals)
// - MPU PLL (Microprocessor Unit)
// - DDR PLL (Memory interface)
```

### 2. DDR RAM Initialization

```c
/* This is the CRITICAL task - without DDR, we can't load U-Boot */
// DDR3 timing parameters are board-specific:
// - CAS Latency
// - tRCD, tRP, tRAS timings
// - Refresh rate
// - Data training/leveling
```

### 3. Load Next Stage

```c
/* SPL locates and loads u-boot.img from boot media */
// On BeagleBone Black:
// - FAT partition: reads u-boot.img from filesystem
// - Raw: reads from fixed offset on eMMC/SD
```

## Building SPL for BeagleBone Black

```bash
# Clone U-Boot
git clone --depth=1 --branch v2024.01 \
    https://source.denx.de/u-boot/u-boot.git
cd u-boot

# Configure for BeagleBone Black
make CROSS_COMPILE=arm-linux-gnueabihf- am335x_evm_defconfig

# Build (generates both MLO and u-boot.img)
make CROSS_COMPILE=arm-linux-gnueabihf- -j$(nproc)

# Check outputs
ls -la MLO u-boot.img
# MLO        - SPL binary with TI header (~100KB)
# u-boot.img - Full U-Boot binary (~500KB)
```

## SPL Configuration Options

In menuconfig (`make menuconfig`):

```
SPL / TPL  --->
    [*] Enable SPL
    [*]   MMC raw mode: by sector
          (0x100) Address on the MMC to load U-Boot from
    [*]   Support FAT filesystems
    [*]   Support loading from a FAT filesystem
    (u-boot.img) Name of file to load for U-Boot
    
    [*] Support SPL loading and booting from NAND
    [*] Support SPL loading and booting from MMC/SD
    [*] Support SPL loading over USB
    [*] Support SPL loading over UART
```

## SPL Size Constraints

BeagleBone Black (AM335x) SRAM map:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    AM335x SRAM LAYOUT (128KB)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Address         Size      Usage                                           │
│   ──────────────────────────────────────────────────────────────────────    │
│   0x402F0400      109KB     SPL code + data (loaded by ROM)                 │
│   0x4030B800      1KB       SPL stack                                       │
│   0x4030BC00      1KB       ROM code reserved                               │
│                                                                             │
│   CONSTRAINT: SPL + stack must fit in ~110KB!                               │
│                                                                             │
│   Typical SPL sizes:                                                        │
│   • Minimal SPL:     50-70KB                                                │
│   • With FAT support: 80-100KB                                              │
│   • With USB/Net:    100-120KB (tight fit!)                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## SPL Boot Media Support

### SD Card Boot (Most Common for Development)

```
SD Card Partition Layout:
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   Sector 0-127:  Reserved (MBR at sector 0)                                 │
│                                                                             │
│   Option A: FAT Partition Method                                            │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ Partition 1 (FAT32, bootable)                                       │   │
│   │   MLO           ← Must be first file copied!                        │   │
│   │   u-boot.img    ← U-Boot proper                                     │   │
│   │   zImage        ← Kernel (optional here)                            │   │
│   │   am335x-boneblack.dtb                                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ Partition 2 (ext4)                                                  │   │
│   │   / (root filesystem)                                               │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   Option B: Raw Sector Method                                               │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ Sectors 256-511:    MLO (raw)                                       │   │
│   │ Sectors 768-1023:   u-boot.img (raw)                                │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Creating Bootable SD Card

```bash
# Identify SD card device (BE CAREFUL - wrong device = data loss!)
lsblk
# Usually /dev/sdb or /dev/mmcblk0

SD_DEV=/dev/sdb

# Create partitions
sudo fdisk ${SD_DEV} << EOF
o
n
p
1

+128M
t
c
a
n
p
2


w
EOF

# Format partitions
sudo mkfs.vfat -F 32 -n BOOT ${SD_DEV}1
sudo mkfs.ext4 -L rootfs ${SD_DEV}2

# Mount boot partition
sudo mount ${SD_DEV}1 /mnt

# Copy boot files (ORDER MATTERS for MLO!)
sudo cp MLO /mnt/
sudo cp u-boot.img /mnt/
sudo cp zImage /mnt/
sudo cp am335x-boneblack.dtb /mnt/

# Sync and unmount
sudo sync
sudo umount /mnt
```

> ⚠️ **Critical**: MLO must be the **first file** copied to a freshly formatted FAT partition. The AM335x ROM looks for it in specific FAT directory entry positions.

## Debugging SPL

### Serial Output

SPL outputs debug messages to UART0:

```
U-Boot SPL 2024.01 (Jan 15 2024 - 10:00:00 +0000)
Trying to boot from MMC1
```

### Common SPL Failure Modes

| Symptom | Cause | Solution |
|---------|-------|----------|
| No output at all | ROM can't find MLO | Check SD card, MLO position |
| "Trying to boot from MMC1" then hangs | DDR init failure | Check power, rebuild SPL |
| "spl: error reading image u-boot.img" | U-Boot not found | Copy u-boot.img to SD |
| Immediate reboot loop | SPL crash | Use UART boot to debug |

### UART Boot for Recovery

If SD/eMMC are corrupted, use UART boot:

```bash
# Install serial boot tool
git clone https://github.com/nicholasjackson/beaglebone-uart-boot
cd beaglebone-uart-boot

# Hold BOOT button + connect power
# Then release BOOT button
# Board enters UART boot mode

# Send SPL via UART (example with sx)
sx MLO > /dev/ttyACM0 < /dev/ttyACM0
```

## SPL Source Code Structure

In U-Boot source:

```
u-boot/
├── arch/arm/mach-omap2/
│   ├── am33xx/
│   │   ├── board.c          # AM335x board init
│   │   ├── clock.c          # Clock configuration
│   │   ├── ddr.c            # DDR initialization
│   │   └── emif4.c          # Memory controller
│   └── spl_build.c          # SPL specific builds
│
├── board/ti/am335x/
│   ├── board.c              # BeagleBone specific
│   ├── board.h              # Board definitions
│   └── mux.c                # Pin multiplexing
│
├── common/spl/
│   ├── spl.c                # Common SPL framework
│   ├── spl_mmc.c            # MMC/SD boot
│   ├── spl_fat.c            # FAT filesystem
│   └── spl_ymodem.c         # UART boot
│
└── include/configs/
    └── am335x_evm.h         # BeagleBone configuration
```

## What You Learned

After studying this document:

1. ✅ Why SPL exists (SRAM size constraints)
2. ✅ What SPL does (clock, DDR, load U-Boot)
3. ✅ BeagleBone Black boot sequence
4. ✅ SPL naming conventions (MLO)
5. ✅ How to build SPL for BeagleBone Black
6. ✅ SD card layout requirements
7. ✅ SPL debugging techniques

---

## Next Steps

- Continue to [SPL/U-Boot Relationship](uboot_spl_relationship.md)
- Or proceed to [Lab 02: U-Boot](../02_uboot/README.md)
