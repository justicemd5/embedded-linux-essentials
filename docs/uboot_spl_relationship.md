# SPL and U-Boot Relationship

> ⚠️ **Auto-Generated Content**: This document was generated by AI. Verify all information against official documentation before use on real hardware.

Understanding how SPL (Secondary Program Loader) and U-Boot work together on BeagleBone Black.

## Overview

SPL and U-Boot are built from the **same source code** but with different configurations. They form a two-stage bootloader where SPL handles hardware initialization and U-Boot handles everything else.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SPL vs U-BOOT: SAME SOURCE, DIFFERENT BUILD              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   U-Boot Source Code                                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                                                                     │   │
│   │   #ifdef CONFIG_SPL_BUILD                                           │   │
│   │       /* Minimal code for SPL */                                    │   │
│   │       /* Only DDR init, basic I/O, image loading */                 │   │
│   │   #else                                                             │   │
│   │       /* Full U-Boot code */                                        │   │
│   │       /* Shell, scripting, network, filesystem, etc. */             │   │
│   │   #endif                                                            │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                        │                                                    │
│           ┌────────────┴────────────┐                                       │
│           │                         │                                       │
│           v                         v                                       │
│   ┌───────────────────┐    ┌───────────────────┐                            │
│   │       MLO         │    │    u-boot.img     │                            │
│   │   (SPL binary)    │    │  (Full U-Boot)    │                            │
│   │     ~100KB        │    │    ~500KB         │                            │
│   │  Runs from SRAM   │    │  Runs from DDR    │                            │
│   └───────────────────┘    └───────────────────┘                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Build Process

When you build U-Boot for BeagleBone Black, both SPL and U-Boot are generated:

```bash
# Configure for BeagleBone Black
make CROSS_COMPILE=arm-linux-gnueabihf- am335x_evm_defconfig

# Build generates BOTH outputs
make CROSS_COMPILE=arm-linux-gnueabihf- -j$(nproc)

# Two separate binaries are produced:
ls -la MLO u-boot.img

# MLO (SPL):
# -rw-r--r-- 1 user user 108696 Jan 15 10:00 MLO

# u-boot.img (Full U-Boot):
# -rw-r--r-- 1 user user 516396 Jan 15 10:00 u-boot.img
```

## Memory Transitions

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    MEMORY STATE DURING BOOT                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   STAGE 1: ROM Bootloader (in silicon)                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ SRAM (128KB): [ROM code running] [SPL loaded here]                  │   │
│   │ DDR (512MB):  [UNINITIALIZED - random garbage]                      │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     v ROM jumps to SPL                      │
│                                                                             │
│   STAGE 2: SPL Running                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ SRAM (128KB): [SPL executing] [stack]                               │   │
│   │ DDR (512MB):  [Initializing...] → [Ready!] [U-Boot loaded here]     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     v SPL jumps to U-Boot                   │
│                                                                             │
│   STAGE 3: U-Boot Running                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ SRAM (128KB): [Available for scratch]                               │   │
│   │ DDR (512MB):  [U-Boot code+data] [heap] [stack] [load areas]        │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                     │                                       │
│                                     v U-Boot jumps to kernel                │
│                                                                             │
│   STAGE 4: Kernel Running                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │ DDR (512MB):  [Kernel] [DTB] [initramfs] [free memory managed by    │   │
│   │                                           kernel allocator]         │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Information Passed Between Stages

### ROM → SPL

The Boot ROM passes minimal information:
- Boot device (SD, eMMC, UART, USB)
- SYSBOOT pin configuration

### SPL → U-Boot

SPL passes information via the `spl_image` structure:

```c
struct spl_image_info {
    const char *name;     /* Image name */
    u8 os;                /* OS type (U-Boot, Linux, etc.) */
    ulong load_addr;      /* Where image was loaded */
    ulong entry_point;    /* Where to jump */
    u32 size;             /* Image size */
    u32 flags;            /* Image flags */
    void *arg;            /* Additional arguments */
};
```

### U-Boot → Kernel

U-Boot passes information via:
- **Device Tree (DTB)**: Hardware description, modified by U-Boot
- **bootargs**: Kernel command line (console, root, etc.)
- **ATAGs** (legacy): Older method, rarely used now

## Configuration Differences

### SPL-Specific Configuration

In `include/configs/am335x_evm.h`:

```c
/* SPL configuration */
#define CONFIG_SPL_FRAMEWORK
#define CONFIG_SPL_TEXT_BASE        0x402F0400  /* SRAM address */
#define CONFIG_SPL_MAX_SIZE         (112 * 1024) /* Max 112KB */
#define CONFIG_SPL_STACK            0x4030B800  /* Stack in SRAM */

#define CONFIG_SPL_BSS_START_ADDR   0x80000000  /* DDR start */
#define CONFIG_SPL_BSS_MAX_SIZE     0x80000     /* 512KB BSS */

/* What SPL supports */
#define CONFIG_SPL_MMC_SUPPORT
#define CONFIG_SPL_FAT_SUPPORT
#define CONFIG_SPL_LIBCOMMON_SUPPORT
#define CONFIG_SPL_SERIAL_SUPPORT

/* What SPL loads */
#define CONFIG_SPL_OS_BOOT          /* Can boot kernel directly (Falcon) */
```

### Full U-Boot Configuration

```c
/* Full U-Boot runs from DDR */
#define CONFIG_SYS_TEXT_BASE        0x80800000  /* DDR address */

/* Full feature set */
#define CONFIG_CMD_DHCP
#define CONFIG_CMD_PING
#define CONFIG_CMD_NFS
#define CONFIG_CMD_USB
#define CONFIG_CMD_EXT4
#define CONFIG_CMD_BOOTZ
#define CONFIG_HUSH_PARSER          /* Shell scripting */
#define CONFIG_AUTO_COMPLETE        /* Tab completion */
```

## Falcon Mode: Skip U-Boot

For faster boot, SPL can load the kernel directly (Falcon Mode):

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    NORMAL vs FALCON MODE                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   NORMAL BOOT:                                                              │
│   ROM → SPL → U-Boot → Kernel                                               │
│               ↑                                                             │
│               Interactive shell, environment, network, etc.                 │
│               Adds 2-5 seconds to boot                                      │
│                                                                             │
│   FALCON MODE:                                                              │
│   ROM → SPL → Kernel                                                        │
│          ↑                                                                  │
│          SPL directly loads kernel, skipping full U-Boot                    │
│          Saves 2-5 seconds, but no interactive control                      │
│                                                                             │
│   Use Case: Production devices needing fast boot                            │
│   Limitation: No network boot, no interactive debugging                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Enable Falcon Mode

```bash
# In menuconfig
make menuconfig

# Navigate to:
# SPL / TPL  --->
#     [*] Support booting directly to Linux
#     [*]   Support MMC Falcon boot

# Prepare Falcon boot (from U-Boot prompt)
=> spl export fdt ${loadaddr} - ${fdt_addr}
=> fatwrite mmc 0:1 ${loadaddr} args 0x${filesize}
```

## Debugging SPL/U-Boot Interaction

### Enable SPL Debug Output

```bash
# In menuconfig
make menuconfig

# SPL / TPL --->
#     [*] Enable debug output in SPL

# Or in board config:
#define DEBUG
#define CONFIG_SPL_LIBCOMMON_SUPPORT
#define CONFIG_SPL_SERIAL_SUPPORT
```

### Serial Output Example

```
U-Boot SPL 2024.01 (Jan 15 2024 - 10:00:00 +0000)
Trying to boot from MMC1
SPL: Image offset: 0x800
SPL: Boot device: MMC1
SPL: Loading image to 0x80800000
SPL: Image size: 516396 bytes
SPL: Jumping to U-Boot

U-Boot 2024.01 (Jan 15 2024 - 10:00:00 +0000)

CPU  : AM335X-GP rev 2.1
Model: TI AM335x BeagleBone Black
DRAM:  512 MiB
...
```

## Common Issues

### SPL Can't Find U-Boot

```
Trying to boot from MMC1
SPL: Error reading image u-boot.img
SPL: Image load failed
```

**Solutions:**
1. Verify `u-boot.img` exists on boot partition
2. Check filename matches `CONFIG_SPL_FS_LOAD_PAYLOAD_NAME`
3. Ensure FAT partition is formatted correctly

### SPL Loads U-Boot but U-Boot Crashes

```
U-Boot SPL 2024.01
Trying to boot from MMC1
(nothing more, or garbage characters)
```

**Solutions:**
1. Verify U-Boot was built for correct DDR address
2. Check DDR initialization in SPL
3. Verify SPL and U-Boot were built together (matching versions)

### Version Mismatch

```
# SPL and U-Boot must be from same build!
# Mixing versions causes problems because:
# - Load addresses may differ
# - Structure layouts may change
# - DDR configuration may differ

# ALWAYS rebuild both together
make mrproper
make am335x_evm_defconfig
make -j$(nproc)
# Use BOTH MLO and u-boot.img from same build
```

## Summary: What Each Stage Does

| Aspect | SPL (MLO) | U-Boot |
|--------|-----------|--------|
| **Runs from** | Internal SRAM (128KB) | DDR RAM (512MB) |
| **Size** | ~100KB max | ~500KB typical |
| **Main job** | DDR init, load U-Boot | Load kernel, user interaction |
| **Features** | Minimal | Full |
| **Shell** | None | Hush parser, scripts |
| **Network** | Usually disabled | DHCP, TFTP, NFS |
| **Filesystems** | FAT (maybe ext4) | FAT, ext2/3/4, UBI |
| **Debug** | Serial output only | Full environment |

## What You Learned

After studying this document:

1. ✅ SPL and U-Boot are from the same source
2. ✅ How memory state changes between stages
3. ✅ What information passes between stages
4. ✅ Configuration differences between SPL and U-Boot
5. ✅ Falcon Mode for fast boot
6. ✅ Common debugging techniques
7. ✅ Version matching requirements

---

## Next Steps

- Proceed to [Lab 02: U-Boot](../02_uboot/README.md) for hands-on practice
- Or read [U-Boot Overview](uboot_overview.md) for deeper U-Boot internals
