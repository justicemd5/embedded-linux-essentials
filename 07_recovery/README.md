# Lab 07: Recovery Techniques

> ⚠️ **Auto-Generated Content**: This document was generated by AI. Verify all commands before running on real hardware.

A hands-on lab for recovering bricked **BeagleBone Black** boards and debugging boot failures.

## Lab Objectives

By the end of this lab, you will be able to:

1. Diagnose common boot failure scenarios on BeagleBone Black
2. Recover boards via UART/Serial console
3. Use TFTP for emergency reflashing
4. Implement and test A/B partition schemes
5. Set up watchdog-based recovery

## Prerequisites

- Completed [Lab 01: Boot Flow](../01_boot_flow/README.md)
- **BeagleBone Black Rev. C** with required accessories
- USB Programming Cable (provides serial via /dev/ttyACM0)
- SD card reader
- TFTP server (from [Lab 06](../06_nfs_boot/README.md))

## Lab Structure

```
07_recovery/
├── README.md              ← This file
├── tftp_recovery.md       ← Emergency TFTP recovery guide
└── uart_debugging.md      ← UART debugging techniques
```

---

## Part 1: Understanding Boot Failures on BeagleBone Black

### BeagleBone Black Boot Sequence

```
AM335x ROM → MLO (SPL) → u-boot.img → Kernel → Userspace
```

### Common Failure Modes

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       BOOT FAILURE CLASSIFICATION                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  POWER-ON                                                                   │
│      │                                                                      │
│      v                                                                      │
│  ┌────────────────────┐                                                     │
│  │ Nothing on Serial  │──► Hardware/Power issue, ROM failure                │
│  │ (No output at all) │    Check: power, cable, ROM boot media              │
│  └────────────────────┘                                                     │
│      │                                                                      │
│      v                                                                      │
│  ┌────────────────────┐                                                     │
│  │ Boot ROM output    │──► SPL/U-Boot not loading                           │
│  │ then stops         │    Check: SD card format, bootloader files          │
│  └────────────────────┘                                                     │
│      │                                                                      │
│      v                                                                      │
│  ┌────────────────────┐                                                     │
│  │ U-Boot prompt      │──► Kernel/DTB loading issue                         │
│  │ but kernel fails   │    Check: file paths, bootargs, DTB                 │
│  └────────────────────┘                                                     │
│      │                                                                      │
│      v                                                                      │
│  ┌────────────────────┐                                                     │
│  │ Kernel boots then  │──► Root filesystem issue                            │
│  │ panics/hangs       │    Check: rootfs, init, bootargs                    │
│  └────────────────────┘                                                     │
│      │                                                                      │
│      v                                                                      │
│  ┌────────────────────┐                                                     │
│  │ Userspace issues   │──► init/systemd/application bugs                    │
│  │ (services fail)    │    Check: logs, dependencies, config                │
│  └────────────────────┘                                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Diagnosis Checklist

| Symptom | Likely Cause | Quick Fix |
|---------|--------------|-----------|
| No serial output | Power, cable, ROM mode | Check power, verify cable, check boot pins |
| "MMC: no card present" | SD card issue | Reseat card, try different card |
| "Bad Linux ARM zImage" | Corrupted kernel | Re-copy kernel to SD |
| "Kernel panic - VFS" | Can't mount root | Check bootargs root= parameter |
| Hangs after "Starting kernel" | DTB mismatch, no console | Verify DTB, check console= arg |

---

## Part 2: Serial Console Recovery

### UART Connection

```bash
# Find USB serial device
ls /dev/ttyUSB* /dev/ttyACM*

# Connect with screen
screen /dev/ttyUSB0 115200

# Or with minicom
minicom -D /dev/ttyUSB0 -b 115200

# Or with picocom
picocom -b 115200 /dev/ttyUSB0
```

### Interrupt Boot Process

Most bootloaders allow interrupt during boot:

```
# Watch for this message during power-on:
Hit any key to stop autoboot:  3

# Press any key quickly to get U-Boot prompt:
=>
```

### U-Boot Recovery Commands

```bash
# Check environment
=> printenv

# Check SD card
=> mmc info
=> mmc part
=> ls mmc 0:1

# Load and boot manually
=> fatload mmc 0:1 ${loadaddr} zImage
=> fatload mmc 0:1 ${fdt_addr} board.dtb
=> setenv bootargs console=ttyS0,115200 root=/dev/mmcblk0p2 rootwait
=> bootz ${loadaddr} - ${fdt_addr}
```

---

## Part 3: TFTP Emergency Recovery

### When to Use TFTP Recovery

- Corrupted SD card
- Need to reflash without removing storage
- Broken filesystem but network works
- CI/CD automated recovery

### Setup (Host Side)

```bash
# Ensure TFTP server is running
sudo systemctl status tftpd-hpa

# Copy recovery images
sudo cp u-boot.bin /tftpboot/
sudo cp zImage /tftpboot/
sudo cp board.dtb /tftpboot/
sudo cp rootfs.ext4 /tftpboot/  # If reflashing rootfs
```

### Recovery Procedure (Target Side)

```bash
# At U-Boot prompt:

# Configure network
=> setenv ipaddr 192.168.1.50
=> setenv serverip 192.168.1.100

# Test connectivity
=> ping ${serverip}

# Download kernel
=> tftp ${loadaddr} zImage

# Download DTB
=> tftp ${fdt_addr} board.dtb

# Boot via TFTP
=> setenv bootargs console=ttyS0,115200 root=/dev/nfs nfsroot=192.168.1.100:/export/rootfs,v3 ip=dhcp
=> bootz ${loadaddr} - ${fdt_addr}
```

### Reflashing SD Card via TFTP

```bash
# Download image to RAM
=> tftp ${loadaddr} sdcard.img

# Write to SD card (DANGEROUS - overwrites everything!)
=> mmc write ${loadaddr} 0 <sector_count>

# Calculate sector_count: filesize / 512
# Example: 500MB image = 500*1024*1024/512 = 0xFA000 sectors
```

---

## Part 4: USB Recovery Mode

### Raspberry Pi USB Boot

```bash
# Some Pi models support USB boot
# Enable via raspi-config or config.txt:
program_usb_boot_mode=1
```

### BeagleBone USB Boot Mode

Hold the BOOT button while powering on:
1. BBB boots into USB/Serial recovery mode
2. Use `am335x_boneblack_defconfig` for USB gadget support
3. Flash via USB mass storage

### i.MX USB Serial Download

```bash
# Install imx_usb_loader
git clone https://github.com/boundarydevices/imx_usb_loader
cd imx_usb_loader
make

# Boot i.MX via USB
./imx_usb u-boot-with-spl.bin
```

### STM32MP1 DFU Mode

```bash
# Install dfu-util
sudo apt-get install dfu-util

# List DFU devices (board in DFU mode)
dfu-util -l

# Flash partitions
dfu-util -a 0 -D u-boot.stm32
dfu-util -a 1 -D tf-a.stm32
```

---

## Part 5: A/B Partition Recovery

### A/B Partition Layout

```
┌───────────────────────────────────────────────────────────────────┐
│                    A/B PARTITION SCHEME                           │
├───────────────────────────────────────────────────────────────────┤
│                                                                   │
│   ┌─────────────────┐  ┌─────────────────┐                        │
│   │    Slot A       │  │    Slot B       │                        │
│   │    (Active)     │  │    (Backup)     │                        │
│   ├─────────────────┤  ├─────────────────┤                        │
│   │ boot_a (kernel) │  │ boot_b (kernel) │                        │
│   ├─────────────────┤  ├─────────────────┤                        │
│   │ rootfs_a        │  │ rootfs_b        │                        │
│   └─────────────────┘  └─────────────────┘                        │
│            │                   │                                   │
│            v                   v                                   │
│   ┌─────────────────────────────────────────────────────────────┐ │
│   │                    Shared Data Partition                    │ │
│   └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│   Boot tries A first. If fails 3 times, switches to B.           │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

### U-Boot A/B Boot Script

```bash
# In U-Boot environment

# Boot attempt counter (stored in persistent env)
=> setenv bootcount 0

# Maximum retries before switching slots
=> setenv bootlimit 3

# Current slot
=> setenv slot a

# Alternate slot
=> setenv altslot b

# A/B boot command
=> setenv ab_boot '
    if test ${bootcount} -gt ${bootlimit}; then
        echo "Slot ${slot} failed. Switching to ${altslot}";
        setenv slot ${altslot};
        setenv bootcount 0;
        saveenv;
    fi;
    setexpr bootcount ${bootcount} + 1;
    saveenv;
    echo "Booting slot ${slot} (attempt ${bootcount})";
    run boot_${slot};
'

# Slot A boot
=> setenv boot_a 'fatload mmc 0:1 ${loadaddr} zImage-a; fatload mmc 0:1 ${fdt_addr} board-a.dtb; setenv bootargs root=/dev/mmcblk0p2 rootwait; bootz ${loadaddr} - ${fdt_addr}'

# Slot B boot
=> setenv boot_b 'fatload mmc 0:3 ${loadaddr} zImage-b; fatload mmc 0:3 ${fdt_addr} board-b.dtb; setenv bootargs root=/dev/mmcblk0p4 rootwait; bootz ${loadaddr} - ${fdt_addr}'

# Set bootcmd
=> setenv bootcmd 'run ab_boot'
=> saveenv
```

---

## Part 6: Watchdog Recovery

### Why Watchdog?

- Detects system hangs
- Automatically reboots on failure
- Combined with A/B, enables autonomous recovery

### Enable in Kernel

```bash
CONFIG_WATCHDOG=y
CONFIG_WATCHDOG_CORE=y
# Platform-specific driver:
CONFIG_BCM2835_WDT=y     # Raspberry Pi
CONFIG_OMAP_WATCHDOG=y   # BeagleBone
CONFIG_IMX2_WDT=y        # i.MX
```

### Userspace Watchdog Daemon

```bash
# Install watchdog daemon
sudo apt-get install watchdog

# Configure /etc/watchdog.conf
watchdog-device = /dev/watchdog
watchdog-timeout = 60
interval = 30
```

### Simple Watchdog Script

```bash
#!/bin/bash
# /usr/local/bin/app_watchdog.sh

WATCHDOG_DEV="/dev/watchdog"
TIMEOUT=60

# Open watchdog
exec 3>$WATCHDOG_DEV

# Main loop - pet the watchdog while app is healthy
while true; do
    if pgrep -x "my_critical_app" > /dev/null; then
        # App running, pet the dog
        echo "V" >&3
    else
        # App died, let watchdog timeout and reboot
        echo "Critical app died, watchdog will trigger reboot"
    fi
    sleep 30
done
```

---

## Lab Exercises

### Exercise 1: Diagnose Boot Failure

1. Intentionally break your boot (rename kernel)
2. Observe failure symptoms on serial
3. Identify the failure point
4. Fix from U-Boot prompt

### Exercise 2: TFTP Emergency Boot

1. Set up TFTP server with kernel and DTB
2. Boot entirely from network
3. Document the minimal recovery procedure

### Exercise 3: Create Recovery SD Card

1. Create minimal recovery partition on SD card
2. Boot into recovery by pressing button
3. Implement "factory reset" that restores main partition

### Exercise 4: Implement A/B Scheme

1. Create partition layout with A and B slots
2. Implement boot count and slot switching
3. Test failure recovery

---

## Troubleshooting Reference

### Serial Console Issues

```bash
# Permission denied
sudo usermod -a -G dialout $USER
# Log out and back in

# Garbage characters
# - Check baud rate matches target (usually 115200)
# - Check hardware flow control is disabled

# No output at all
# - Verify TX/RX wiring (may need swap)
# - Check ground connection
# - Verify target is powered
```

### Common U-Boot Errors

```bash
# "MMC: no card present"
# - Reseat SD card
# - Try different slot/card

# "** Bad device mmc 0 **"
# - mmc rescan
# - Check device number (mmc 0 vs mmc 1)

# "Loading Environment from nowhere..."
# - Normal for first boot, saveenv will fix

# "Wrong Image Format"
# - Kernel format wrong (use zImage not uImage)
# - Or try: bootz vs bootm
```

---

## What You Learned

After completing this lab:

1. ✅ Systematic boot failure diagnosis
2. ✅ UART-based debugging and recovery
3. ✅ TFTP emergency booting
4. ✅ A/B partition concepts
5. ✅ Watchdog-based autonomous recovery

---

## Next Steps

Continue to [Exercises](../exercises/) to practice your skills with graded challenges.
